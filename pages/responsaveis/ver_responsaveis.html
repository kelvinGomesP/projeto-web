<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lista de Responsáveis</title>
  <link rel="stylesheet" href="../../styles/responsaveis.css" />
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    .btn-voltar, .btn-cadastrar {
      display: inline-block;
      margin-top: 10px;
      text-decoration: none;
      background-color: #555;
      color: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      margin-right: 10px;
    }

    .btn-voltar:hover, .btn-cadastrar:hover {
      background-color: #333;
    }

    .btn-acao {
      margin-right: 5px;
      padding: 6px 10px;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-acao.excluir {
      background-color: #cc0000;
    }

    .btn-acao:hover {
      opacity: 0.9;
    }

    /* Estilos para a barra de pesquisa */
    .search-container {
      margin: 20px 0;
      display: flex;
      gap: 10px;
    }

    .search-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }

    .search-button {
      padding: 10px 20px;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .search-button:hover {
      background-color: #0055aa;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Lista de Responsáveis Cadastrados</h1>

    <!-- BOTÃO PARA CADASTRAR -->
    <a href="cadastrar.html" class="btn-cadastrar">+ Cadastrar Responsável</a>
    <!-- BOTÃO DE VOLTAR -->
    <a href="/" class="btn-voltar">← Voltar</a>

    <!-- BARRA DE PESQUISA -->
    <div class="search-container">
      <input type="text" id="searchInput" class="search-input" placeholder="Pesquisar por nome, CPF ou aluno...">
      <button class="search-button" onclick="filterTable()">Pesquisar</button>
    </div>

    <table id="tabela-responsaveis">
      <thead>
        <tr>
          <th>Nome do Responsavel</th>
          <th>Nome do Aluno</th>
          <th>CPF</th>
          <th>Email</th>
          <th>Telefone</th>
          <th>Endereço</th>
          <th>ID(s) do(s) Aluno(s)</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dados serão inseridos via JavaScript -->
      </tbody>
    </table>
  </div>

<script>
  // Variável para armazenar todos os responsáveis
  let allResponsaveis = [];

  // Ao carregar a página, busca os responsáveis
  fetch('/PassUsers')
    .then(response => response.json())
    .then(data => {
      allResponsaveis = data;
      const tabela = document.querySelector('#tabela-responsaveis tbody');
      
      if (Array.isArray(data)) {
        renderTable(data);
      } else {
        tabela.innerHTML = `<tr><td colspan="8">Nenhum responsável encontrado.</td></tr>`;
      }
    })
    .catch(error => {
      console.error('Erro ao carregar responsáveis:', error);
      const tabela = document.querySelector('#tabela-responsaveis tbody');
      tabela.innerHTML = `<tr><td colspan="8">Erro ao carregar dados.</td></tr>`;
    });

  // Função para renderizar a tabela com os dados
  function renderTable(data) {
    const tabela = document.querySelector('#tabela-responsaveis tbody');
    tabela.innerHTML = '';
    
    if (data.length === 0) {
      tabela.innerHTML = `<tr><td colspan="8">Nenhum resultado encontrado.</td></tr>`;
      return;
    }
    
    data.forEach(responsavel => {
      const linha = document.createElement('tr');
      linha.innerHTML = `
        <td>${responsavel.nome}</td>
        <td>${responsavel.nomeAluno}</td>
        <td>${responsavel.cpf}</td>
        <td>${responsavel.email}</td>
        <td>${responsavel.telefone}</td>
        <td>${responsavel.endereco}</td>
        <td>${responsavel.aluno_id || responsavel.idAluno}</td>
        <td>
          <button class="btn-acao editar" onclick="editarResponsavel('${responsavel.cpf}')">Editar</button>
          <button class="btn-acao excluir" onclick="excluirResponsavel('${responsavel.cpf}')">Excluir</button>
        </td>
      `;
      tabela.appendChild(linha);
    });
  }

  // Função para filtrar a tabela
  function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    if (!searchTerm) {
      renderTable(allResponsaveis);
      return;
    }
    
    const filteredData = allResponsaveis.filter(responsavel => {
      return (
        responsavel.nome.toLowerCase().includes(searchTerm) ||
        (responsavel.nomeAluno && responsavel.nomeAluno.toLowerCase().includes(searchTerm)) ||
        responsavel.cpf.toLowerCase().includes(searchTerm) ||
        responsavel.email.toLowerCase().includes(searchTerm) ||
        responsavel.telefone.toLowerCase().includes(searchTerm)
      );
    });
    
    renderTable(filteredData);
  }

  // Permitir pesquisa ao pressionar Enter
  document.getElementById('searchInput').addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
      filterTable();
    }
  });

  // Função para excluir responsável
  function excluirResponsavel(cpf) {
    // Remove pontos e traço do CPF (formatação)
    const cpfLimpo = cpf.replace(/\D/g, '');
    
    if (confirm('Tem certeza que deseja excluir este responsável?')) {
      fetch(`/PassUsers/${cpfLimpo}`, {
        method: 'DELETE'
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        location.reload();
      })
      .catch(err => {
        alert('Erro ao excluir responsável');
        console.error(err);
      });
    }
  }

  // Função para redirecionar para tela de edição
  function editarResponsavel(cpf) {
    // Redireciona para página de edição com CPF na URL
    window.location.href = `cadastrar.html?cpf=${encodeURIComponent(cpf)}`;
  }
</script>

</body>
</html>